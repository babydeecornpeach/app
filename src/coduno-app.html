<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/helpers/helpers.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<!-- Since 'home' is the default route, eagerly load it. -->
<link rel="import" href="admin/admin-page.html">
<link rel="import" href="common/login/login-wizard/login-wizard.html">
<link rel="import" href="common/register/register-page.html">
<link rel="import" href="../src/styles/coduno.html">
<link rel="import" href="common/services/cookie-service.html">
<link rel="import" href="coder/profile/profile-page.html">



<dom-module id="coduno-app">

    <template>

        <style include="coduno-style">
            :host {
                display: block;
                height: 100%;
                width: 100%;
                margin: 0;
                padding: 0;
            }
        </style>

        <!--
          app-location and app-route elements provide the state of the URL for the app.
        -->
        <app-location route="{{route}}"></app-location>
        <app-route
                route="{{route}}"
                pattern="/:page"
                data="{{routeData}}"></app-route>


        <app-header style="background-color: lightblue" role="navigation" id="header" effects="waterfall" condenses reveals>
            <app-toolbar>

                <div>Yo Coduno</div>
                <a href="/admin">Click here to open admin page</a>
            </app-toolbar>
        </app-header>

        <iron-pages role="main" selected="[[page]]" attr-for-selected="name" selected-attribute="visible">
            <admin-page name="admin"></admin-page>
            <register-page name="register"></register-page>
            <login-wizard name="login"></login-wizard>
            <profile-page name="u"></profile-page>

        </iron-pages>

        <paper-button raised>this is a paper button</paper-button>

    </template>

    <script>
        Polymer({
            is: 'coduno-app',
            properties: {
                page: {
                    type: String,
                    reflectToAttribute: true,
                    observer: '_pageChanged'
                },
                route: {
                    type: Object
                },
                user: {
                    type: Object
                }
            },
            observers: [
                '_routePageChanged(routeData.page)'
            ],
            _pageChanged: function(page) {
                console.log("value changed to", page);
                if(page == "foo") {
                    return;
                }
                this.checkLogin();
            },
            _routePageChanged: function(page) {
                this.page = page;
            },
            checkLogin: function() {
                console.log("USER: ", this.user);
                console.log("route", this.route);
                if(this.user) {
                    this.route.path = "/u/" + this.user.username;
                } else {
                    this.loginUser();
                }
            },
            loginUser: function() {
                var cookieService = document.createElement('cookie-service');
                var that = this;
                cookieService.addEventListener('user-ok', function(e) {
                    that.set("user", e.detail);
                    // that.set(prop, val) vs that.prop = val; used when changing sub objects
                    that.set("route.path", "/u/" + that.user.username);
                    console.log("logged in");
                });
                cookieService.addEventListener('user-error', function() {
                    console.log(that.route);
                    that.set("route.path", "/login");
                    console.log(that.route);
                    console.log("i am NOT logged in");
                });
                cookieService.login();
            }
        });
    </script>

</dom-module>