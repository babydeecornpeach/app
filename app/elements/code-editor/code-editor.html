<link rel="import" href="/elements/submission/ws-element.html">

<dom-module id="code-editor">
	<style>
		:host {
			display: block;
			height: 100%;
		}

		#editor {
			height: 100%;
			z-index:0;
		}
	</style>
	<template>
		<ws-element url="{{wsUrl}}"></ws-element>
		<div id="editor"></div>
	</template>
	<script src="/bower_components/ace-min-noconflict/ace.js" type="application/javascript"></script>
	<script src="/bower_components/ace-min-noconflict/ext-language_tools.js" type="application/javascript"></script>
	<script>
		/*global ace:false */
		Polymer({
			is: 'code-editor',
			properties: {
				wsUrl: {
					type: String,
					notify: true
				}
			},
			ready: function(){
				this.wsUrl = util.getWSUrl('/?result=' + localStorage.getItem('result'));
				ace.require('ace/ext/language_tools');
				this.$.editor = ace.edit(this.$.editor);
				this.$.editor.setTheme('ace/theme/chrome');
				this.$.editor.setOptions({
					enableBasicAutocompletion: true
				});
			},
			runCode: function(lang, taskKey) {
				var body = new FormData();
				// TODO(flowlo): Set correct MIME type.
				body.append('files', new Blob([this.getText()], { type: 'text/plain'}), this._getFile(lang));
				// NOTE(flowlo): This does not use util.post because
				// we need a multipart form.
				var url = util.build('/results/' + localStorage.getItem('result') + '/tasks/' + taskKey +'/submissions');
				var xhr = new XMLHttpRequest();
				xhr.onerror = function(e) {
					// TODO(flowlo): Maybe pass this to util.error?
					console.log(e);
				};
				xhr.withCredentials = true;
				xhr.open('POST', url, true);
				xhr.setRequestHeader('Authorization', 'Token ' + util.accessToken().Value);
				xhr.send(body);
			},
			getText: function() {
				return this.$.editor.getValue();
			},
			setText: function(text){
				this.$.editor.getSession().setValue(text);
			},
			setMode: function(lang){
				var mode = 'ace/mode/java';
				switch (lang) {
					case 'py':
						mode = 'ace/mode/python';
						break;
					case 'c':
						mode = 'ace/mode/c_cpp';
						break;
					case 'cpp':
						mode = 'ace/mode/c_cpp';
						break;
					case 'robot':
						mode = 'ace/mode/c_cpp';
						break;
				}
				this.$.editor.getSession().setMode({
					path: mode,
					v: Date.now()
				});
			},
			_getFile: function(lang){
				switch (lang) {
					case 'java':
						return 'Application.java';
					case 'py':
						return 'app.py';
					case 'c':
						return 'app.c';
					case 'cpp':
						return 'app.cpp';
					case 'robot':
						return 'robot.json';
				}
				return 'default';
			}
		});
	</script>
</dom-module>
