<dom-module id="login-page">
  <template>
    <paper-material elevation="1" style="width: 35%;" class="card">
      <template is="dom-if" if="{{invalidLogin}}">
        <p>Invalid login</p>
      </template>
      <paper-input type="text" label="E-mail" value="{{email}}"></paper-input>
      <paper-input type="password" label="Password" value="{{password}}"></paper-input>
      <paper-button raised on-click="login" style="width: 150px;"><core-icon icon="favorite"></core-icon>Login</paper-button>
    </paper-material>

    <iron-ajax
      id="ajaxRequest"
      handle-as="json"
      on-response="onCompanyResponse"
      on-error="onCompanyError"
      debounce-duration="1000"
      with-credentials="true"
      >
    </iron-ajax>

    <iron-ajax
      id="userRequest"
      handle-as="json"
      on-response="onUserResponse"
      on-error="onUserError"
      debounce-duration="1000"
      with-credentials="true"
      >
    </iron-ajax>


  </template>
</dom-module>
<script>
  (function() {
    Polymer({
      is: 'login-page',
      properties:{
        email: String,
        password: String,
        invalidLogin:{
          type: Boolean,
          notify: true
        }
      },
      login: function(){
        get(this.$.userRequest, '/user', 'Basic ' + btoa(this.email+":"+this.password));
      },
      onCompanyResponse: function(res){
        var company = res.detail.response;
        localStorage.setItem("companyKey", company.Key);
        localStorage.setItem("companyName", company.Name);
        localStorage.setItem("role", "COMPANY");
        app.refreshMenu();
        page.redirect("/candidates");
      },
      onUserResponse: function(res){
        var user = res.detail.response;
        localStorage.setItem('authorization', 'Basic ' + btoa(this.email + ':' + this.password));
        localStorage.setItem("Name", user.Name);
        localStorage.setItem("Nick", user.Nick);
        localStorage.setItem("Address", user.Address);
        get(this.$.ajaxRequest, '/user/company', 'Basic ' + btoa(this.email+":"+this.password));
       },
      onCompanyError: function(error) {
        localStorage.setItem("role", "USER");
        app.refreshMenu();
        page.redirect("/challenge");
      },
      onUserError: function(req){
        this.invalidLogin = true;
      },
      ready: function() {
        this.invalidLogin = false;
      }
    });
  })();
</script>
