<dom-module id="login-page">
  <template>
    <paper-material elevation="1" style="width: 30%; margin: auto;">
      <div class="colorful" style="position:relative; height: 250px;">
        <h1 style="position: absolute; bottom: 0; left: 20px;">Sign in to Coduno</h1>
      </div>
      <div style="padding: 20px 20px 150px 20px;">
        <form is="iron-form" id="form">
          <paper-input type="text" label="E-mail" value="{{email}}"></paper-input>
          <paper-input type="password" label="Password" value="{{password}}"></paper-input>
          <template is="dom-if" if="{{invalidLogin}}">
            <p style="color: red;">The provided e-mail and password do not match.</p>
          </template>
          <div class="horizontal layout" style="padding-top: 10px;">
            <paper-button class="invertcolorful">Forgot password?</paper-button>
            <paper-button class="colorful" raised on-click="login" style="position: absolute; right: 20px;">Login</paper-button>
          </div>
        </form>
      </div>
    </paper-material>

    <iron-ajax
      id="ajaxRequest"
      handle-as="json"
      on-response="onCompanyResponse"
      on-error="onCompanyError"
      debounce-duration="1000"
      with-credentials="true"
      >
    </iron-ajax>

    <iron-ajax
      id="userRequest"
      handle-as="json"
      on-response="onUserResponse"
      on-error="onUserError"
      debounce-duration="1000"
      with-credentials="true"
      >
    </iron-ajax>


  </template>
</dom-module>
<script>
  (function() {
    Polymer({
      is: 'login-page',
      properties:{
        email: String,
        password: String,
        invalidLogin:{
          type: Boolean,
          notify: true
        }
      },
      login: function(){
        get(this.$.userRequest, '/user', 'Basic ' + btoa(this.email+":"+this.password));
      },
      onCompanyResponse: function(res){
        var company = res.detail.response;
        localStorage.setItem("companyKey", company.Key);
        localStorage.setItem("companyName", company.Name);
        app.login("COMPANY");
      },
      onUserResponse: function(res){
        var user = res.detail.response;
        localStorage.setItem('authorization', 'Basic ' + btoa(this.email + ':' + this.password));
        localStorage.setItem("Name", user.Name);
        localStorage.setItem("Nick", user.Nick);
        localStorage.setItem("Address", user.Address);
        get(this.$.ajaxRequest, '/user/company', 'Basic ' + btoa(this.email+":"+this.password));
       },
      onCompanyError: function(error) {
        app.login("CODER");
      },
      onUserError: function(req){
        this.invalidLogin = true;
      },
      ready: function() {
        this.invalidLogin = false;
      }
    });
  })();
</script>
