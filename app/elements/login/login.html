<dom-module id="login-page">
  <style>
  paper-material{
    width: 30%;
    margin: auto;
  }
  #topPart{
    position:relative;
    height: 250px;
    background: #424b4b;
    color: #ffffff;
  }

  #topPart>h1{
    position: absolute;
    bottom: 0;
    left: 20px;
  }
  #bottomPart{
    padding: 20px 20px 150px 20px;
  }

  #buttons{
    padding-top: 10px;
  }

  #loginButton{
    position: absolute;
    right: 20px;
  }
  </style>
  <template>
    <paper-material elevation="1">
      <div id="topPart">
        <h1>Sign in to Coduno</h1>
      </div>
      <div id="bottomPart">
        <form is="iron-form" id="form">
          <paper-input type="text" label="E-mail" value="{{email}}"></paper-input>
          <paper-input type="password" label="Password" value="{{password}}"></paper-input>
          <template is="dom-if" if="{{invalidLogin}}">
            <p style="color: red;">The provided e-mail and password do not match.</p>
          </template>
          <div id="buttons" class="horizontal layout">
            <paper-button class="secondary">Forgot password?</paper-button>
            <paper-button id="loginButton" class="primary" raised on-click="login">Login</paper-button>
          </div>
        </form>
      </div>
    </paper-material>

    <iron-ajax
      id="ajaxRequest"
      handle-as="json"
      on-response="onCompanyResponse"
      on-error="onCompanyError"
      debounce-duration="1000"
      with-credentials="true"
      >
    </iron-ajax>

    <iron-ajax
      id="userRequest"
      handle-as="json"
      on-response="onUserResponse"
      on-error="onUserError"
      debounce-duration="1000"
      with-credentials="true"
      >
    </iron-ajax>


  </template>
</dom-module>
<script>
  (function() {
    Polymer({
      is: 'login-page',
      properties:{
        email: String,
        password: String,
        invalidLogin:{
          type: Boolean,
          notify: true
        }
      },
      login: function(){
        get(this.$.userRequest, '/user', 'Basic ' + btoa(this.email+":"+this.password));
      },
      onCompanyResponse: function(res){
        var company = res.detail.response;
        localStorage.setItem("companyKey", company.Key);
        localStorage.setItem("companyName", company.Name);
        app.login("COMPANY");
      },
      onUserResponse: function(res){
        var user = res.detail.response;
        localStorage.setItem('authorization', 'Basic ' + btoa(this.email + ':' + this.password));
        localStorage.setItem("Name", user.Name);
        localStorage.setItem("Nick", user.Nick);
        localStorage.setItem("Address", user.Address);
        get(this.$.ajaxRequest, '/user/company', 'Basic ' + btoa(this.email+":"+this.password));
       },
      onCompanyError: function(error) {
        app.login("CODER");
      },
      onUserError: function(req){
        this.invalidLogin = true;
      },
      ready: function() {
        this.invalidLogin = false;
      }
    });
  })();
</script>
