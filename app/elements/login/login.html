<link rel="import" href="../../bower_components/paper-input/all-imports.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<dom-module id="login-page">
  <template>
    <paper-material elevation="1" style="width: 35%;">
      <template is="dom-if" if="{{invalidLogin}}">
        <p>Invalid login</p>
      </template>
      <paper-input type="text" label="E-mail" value="{{email}}"></paper-input>
      <paper-input type="password" label="Password" value="{{password}}"></paper-input>
      <paper-button raised on-click="login" style="width: 150px;"><core-icon icon="favorite"></core-icon>Login</paper-button>
    </paper-material>

    <iron-ajax
      id="ajaxRequest"
      handle-as="json"
      on-response="onLoginResponse"
      on-error="onError"
      debounce-duration="1000"
      with-credentials="true"
      >
    </iron-ajax>

    <iron-ajax
            id="userRequest"
            handle-as="json"
            on-response="onUserResponse"
            on-error="onError"
            debounce-duration="1000"
            with-credentials="true"
            >
    </iron-ajax>


  </template>
</dom-module>
<script>
  (function() {
    Polymer({
      is: 'login-page',
      properties:{
        email: String,
        password: String,
        invalidLogin:{
          type: Boolean,
          notify: true
        }
      },
      login: function(){
        get(this.$.ajaxRequest, '/user/company', 'Basic ' + btoa(this.email+":"+this.password));
      },
      onLoginResponse: function(res){
        var response = res.detail.response;
        if (response != null) {
          var company = response;
          localStorage.setItem('authorization', 'Basic ' + btoa(this.email + ':' + this.password));
          localStorage.setItem("companyKey", company.Key);
          localStorage.setItem("companyName", company.Name);
          localStorage.setItem("role", "COMPANY");
          get(this.$.userRequest, '/user');
        }
      },
      onUserResponse: function(res){
        var response = res.detail.response;
        if (response != null){
          var user = response;
          localStorage.setItem("Name", user.Name);
          localStorage.setItem("Nick", user.Nick);
          localStorage.setItem("Address", user.Address);
          page.redirect('/dashboard')
        }
       },
      onError: function(error) {
        this.invalidLogin = true;
        console.log(error);
      },
      ready: function() {
        this.invalidLogin = false;
      }
    });
  })();
</script>
