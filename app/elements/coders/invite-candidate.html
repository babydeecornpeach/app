<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="invite-candidate">
  <style>
    paper-button{
      color: #111111;
    }
  </style>
  <template>
    <iron-ajax
      id="getChallengesAjax"
      handle-as="json"
      on-response="onGetChallengesResponse"
      on-error="onError">
    </iron-ajax>

    <iron-ajax
      id="inviteCandidate"
      handle-as="json"
      on-response="onPostResponse"
      on-error="onError">
    </iron-ajax>

    <h4>An email will be sent to the candidate with the link where he can access the challenge</h4>

    <form is="iron-form" id="form">
      <paper-input id="address" label="Address" value="{{Address}}"></paper-input>
      <select id="challenges" value="{{Challenge}}"></select><br>
      <paper-button raised="" on-click="inviteCandidate">Create</paper-button>
    </form>


  </template>

  <script>
    Polymer({
      is: 'invite-candidate',
      properties: {
        Address: String,
        Challenge: String
      },
      getChallenges: function(){
        get(this.$.getChallengesAjax, '/companies/' + localStorage.getItem("companyKey") + '/challenges');
      },
      inviteCandidate: function(){
        post(this.$.inviteCandidate, '/invitations', {'Address': this.Address, 'Challenge': this.getSelectedChallenge()})
      },
      onGetChallengesResponse: function(res) {
        var select = this.$.challenges;
        var challenges = res.detail.response;
        for (var i = 0; i< challenges.length; i++){
          var opt = document.createElement('option');
          opt.value = challenges[i].key;
          opt.text = challenges[i].Name;
          select.appendChild(opt);
        }
      },
      onPostResponse: function(res){
        page.redirect('/challenges/' + this.getSelectedChallenge());
      },
      onError: function(error){
          handleError(error);
      },
      submitForm: function(){
        this.$.form.submit();
      },
      getSelectedChallenge: function(){
        return this.$.challenges.options[this.$.challenges.selectedIndex].value;
      }
    })
  </script>
</dom-module>
