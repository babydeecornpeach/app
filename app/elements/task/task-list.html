<link rel="import" href="task-card.html">
<link rel="import" href="/elements/challenge/challenge-modal.html">
<link rel="import" href="/elements/task/task-detail.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">

<dom-module id="task-list">
	<style>
		.task-list {
			padding: 10px;
		}

		#createTaskButton {
			position: fixed;
			right: 2%;
			bottom: 5%;
		}
	</style>
	<template>
		<iron-ajax
			id="getTasksAjax"
			handle-as="json"
			on-response="onResponse"
			on-error="onError">
		</iron-ajax>

		<paper-fab id="createTaskButton" on-click="_createTask" icon="create"></paper-fab>
		<div class="horizontal layout wrap task-list">
			<template is="dom-repeat" items="{{tasks}}" as="task">
				<task-card task="{{task}}" selection-view="{{showAllButtons}}">
				</task-card>
			</template>
		</div>
		<challenge-modal id="challengeModal" selected-tasks="{{selectedTasks}}"></challenge-modal>
	</template>
	<script>
		Polymer({
			is: 'task-list',
			properties: {
				tasks: {
					type: Array,
					notify: true
				},
				selectedTasks: {
					type: Array,
					notify: true
				},
				showAllButtons: {
					type: Boolean,
					value: false,
					notify: true
				}
			},
			listeners: {
				'challengeCreated': '_resetSelected',
				'taskDetail': '_taskDetail',
				'task-removed': '_removeTask',
				'task-added': '_addTask'
			},
			createChallenge: function () {
				this.$.challengeModal.toggle();
			},
			getTasks: function () {
				util.get(this.$.getTasksAjax, '/tasks');
			},
			onResponse: function (res) {
				this.tasks = res.detail.response;
				this.selectedTasks = [];
			},
			onError: function (error) {
				util.error(error);
			},
			// listeners for external events
			_resetSelected: function () {
				this.selectedTasks = [];
				this.showAllButtons = false;
			},
			_createTask: function() {
				page.redirect('/task/create');
			},
			_removeTask: function(event){
				var index = this.selectedTasks.indexOf(event.detail);
				this.splice('selectedTasks', index, 1);
				this._taskSelectionLogic();
			},
			_addTask: function(event){
				this.push('selectedTasks', event.detail);
				this._taskSelectionLogic();
			},
			_taskSelectionLogic: function(){
				if(this.selectedTasks.length > 0){
					this.showAllButtons = true;
					app.header = this.selectedTasks.length + ' SELECTED';
				}else{
					this.showAllButtons = false;
					app.header = 'Tasks';
				}
			}
		});
	</script>
</dom-module>
