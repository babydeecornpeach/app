<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-material/paper-material.html">
<link rel="import" href="/elements/submission/challenge-display.html">
<link rel="import" href="/elements/submission/countdown-timer.html">
<!-- TODO(victorbalan): Import this exactly when the challenge has finished -->
<link rel="import" href="/elements/submission/challenge-finished.html">
<link rel="import" href="/elements/submission/challenge-nav.html">

<dom-module id="sequential-challenge">
	<style>
		:host{
			display: block;
			height: 100%;
		}
		#content{
			height: calc(100% - 40px);
		}
		#startChallengeCard{
			width:35%;
		}
		#taskNavHeader{
			height: 40px;
			background: white;
			margin: 0;
			padding: 0;
		}
		#leftProgressFlex{
			margin-right: 50px;
		}
	</style>
	<template>
		<challenge-nav id="coolNav" task-index="{{taskIndex}}" total-tasks="{{totalTasks}}"
		task-duration="{{taskDuration}}" challenge-duration="{{challenge.Duration}}"></challenge-nav>

		<div id="content" style$="{{contentStyle}}">
			<paper-material id="startChallengeCard" elevation="1" class="card">
				<div class="flex">
					<challenge-display challenge="{{challenge}}"></challenge-display>
					<paper-button raised on-click="startChallenge">Go</paper-button>
				</div>
			</paper-material>
		</div>
		<iron-ajax
			id="getResultRequest"
			handle-as="json"
			on-response="onResultResponse"
			on-error="onResultError"
			method="GET"
			with-credentials="true"
			>
		</iron-ajax>
		<iron-ajax
			id="loadTaskRequest"
			handle-as="json"
			on-response="onTaskResponse"
			debounce-duration="1000"
			method="GET"
			with-credentials="true"
			>
		</iron-ajax>
		<iron-ajax
			id="finishTaskRequest"
			handle-as="json"
			debounce-duration="1000"
			content-type="application/json"
			on-response="onFinishTaskResponse"
			on-error="onFinishTaskError"
			method="POST"
			with-credentials="true"
			>
		</iron-ajax>
	</template>
	<script>
		Polymer({
			// TODO(victorbalan): Refactor component and split logic and refactor requests.
			is: 'sequential-challenge',
			properties: {
				totalTasks: Number,
				challenge: {
					type: Object,
					notify: true,
					reflectToAttribute: true
				},
				result: {
					type: Object,
					notify: true,
					reflectToAttribute: true
				},
				task: {
					type: Object,
					notify: true
				},
				taskIndex: {
					type: Number,
					notify: true,
					value: 0
				},
				contentStyle:{
					type: String,
					notify: true,
					value: 'display: none;'
				},
				taskDuration: {
					type: Number,
					notify: true
				}
			},
			observers: [
				'afterPropertiesSet(challenge, result)'
			],
			listeners: {
				'task-timeout': '_taskTimeout',
				'challenge-timeout': '_challengeTimeout'
			},
			afterPropertiesSet: function(){
				var currentTask = '';
				this.totalTasks = this.challenge.Tasks.length;
				for(var i=0; i<this.result.StartTimes.length; i++){
					if(new Date(this.result.StartTimes[i]).getTime()>0){
						this.taskIndex = i;
						currentTask = this.challenge.Tasks[i];
					}
				}
				if(currentTask !== '' && this.taskIndex >= 0){
					localStorage.setItem('challengeTimer', new Date(this.result.StartTimes[0]).getTime());
					localStorage.setItem('taskTimer', new Date(this.result.StartTimes[this.taskIndex]).getTime());
					this.loadTaskById(currentTask);
					this.$.coolNav.start();
				}else{
					this.contentStyle = '';
				}
			},
			startChallenge: function() {
				this.$.content.innerHTML = '';
				localStorage.setItem('challengeTimer', Date.now());
				this.loadTaskById(this.challenge.Tasks[this.taskIndex]);
				this.$.coolNav.start();
			},
			loadTaskById: function(key){
				this.$.loadTaskRequest.url = util.build('/tasks/' + key + '?result=' + localStorage.getItem('result'));
				this.$.loadTaskRequest.generateRequest();
			},
			onTaskResponse: function(r){
				if(!localStorage.getItem('taskTimer')){
					localStorage.setItem('taskTimer', Date.now());
				}
				var task = r.detail.response;
				this.task = task;
				// TODO(victorbalan): Replace this taskDuration with task.Assignment.Duration
				// after investigating why Assignment has 2 fields: Duration and Duration} wich is NaN
				this.taskDuration = this.task.Assignment.Duration;
				this.$.coolNav.refreshTaskTimer();
				this.importHref('/elements/submission/tasks/' + task.Assignment.Endpoints.WebInterface + '.html', function(){
					var webInterface = document.createElement(task.Assignment.Endpoints.WebInterface);
					webInterface.task = task;
					var component = this;
					webInterface.addEventListener('task-finished', function(){
						component.finishTask();
					});
					this.$.content.innerHTML = '';
					this.$.content.appendChild(webInterface);
					this.contentStyle = '';
				});
			},
			finishTask: function(){
				this.$.finishTaskRequest.url = util.build(
					'/results/'+ localStorage.getItem('result') +
					'/finalSubmissions/' + this.taskIndex +
					'?submissionKey' + localStorage.getItem('lastSubmission')
				);
				this.$.finishTaskRequest.body = {};
				this.$.finishTaskRequest.generateRequest();
			},
			onFinishTaskResponse: function(){
				this._nextTask();
			},
			_nextTask: function(){
				localStorage.removeItem('taskTimer');
				this.taskIndex++;
				if(this.taskIndex < this.challenge.Tasks.length){
					this.loadTaskById(this.challenge.Tasks[this.taskIndex]);
				}else{
					this.$.coolNav.stop();
					this.$.getResultRequest.url = util.build('/results/' + localStorage.getItem('result'));
					this.$.getResultRequest.generateRequest();
					var finished = document.createElement('challenge-finished');
					this.$.content.innerHTML = '';
					this.$.content.appendChild(finished);
					app.finishChallenge();
				}
			},
			onFinishTaskError: function(err) {
				util.error(err);
			},
			onResultResponse: function(r){
				console.log(r);
			},
			onResultError: function(err){
				console.log(err);
			},
			_taskTimeout: function(){
				this._nextTask();
			},
			_challengeTimeout: function(){
				this.importHref('/elements/submission/challenge-timeout.html', function(){
					var webInterface = document.createElement('challenge-timeout');
					this.$.content.innerHTML = '';
					this.$.content.appendChild(webInterface);
					this.contentStyle = '';
				});
			}
		});

	</script>
</dom-module>
