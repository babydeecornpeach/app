<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">

<dom-module id="file-exporer-item">
	<template>
		<style include="iron-flex">
			div#wrapper {
				background-color: inherit;
				@apply(--layout-horizontal);
				padding: 3px;
			}
			div#wrapper.selected, div#wrapper:hover {
				background-color: lightgray;
			}
			div#wrapper:hover {
				cursor: pointer;
			}
			#editInput {
				width: calc(100% - 26px);
			}
		</style>
		<div class$="[[className]]" id="wrapper" on-click="select">
			<iron-icon icon="[[icon]]"></iron-icon>
			<template is="dom-if" if="{{renaming}}">
				<input id="editInput" type="text" value="[[childPath]]" on-keyup="handleKeyUp" autofocus>
			</template>
			<template is="dom-if" if="{{!renaming}}">
				<div class="name">{{name}}</div>
			</template>
		</div>
		<paper-toast id="toast"></paper-toast>
		<paper-dialog>
			<h1>{{dialogTitle}}</h1>
			<input type="text" on-keyup="handleKeyUp" autofocus>
		</paper-dialog>
	</template>
	<script>
		Polymer({
			is: 'file-exporer-item',
			properties: {
				name: {
					type: String,
					reflectToAttribute: true
				},
				file: {
					type: Object,
					reflectToAttribute: true
				},
				path: {
					type: String,
					reflectToAttribute: true
				},
				intention: {
					type: String,
					observer: 'intentionChanged'
				},
				childPath: {
					type: String,
					computed: 'computeChildPath(path, name)'
				},
				isDirectory: {
					type: Boolean,
					reflectToAttribute: true,
					computed: 'computeIsDirectory(file)'
				},
				icon: {
					type: String,
					computed: 'computeIcon(isDirectory)'
				},
				renaming: {
					value: false
				},
				className: {
					value: ''
				}
			},
			listeners: {
				'contextmenu': 'showContextMenu'
			},
			computeIsDirectory: function(file) {
				return (typeof file) === 'object';
			},
			computeIcon: function(isDirectory) {
				return isDirectory ? 'folder' : 'assignment';
			},
			intentionChanged: function(intention) {
				if (['delete', 'add-file', 'add-folder', 'rename'].indexOf(intention) < 0) {
					console.log('Unrecognized intention set:', intention);
				}
			},
			select: function() {
				this.set('className', 'selected');
				this.fire('file-selected', this);
			},
			unselectFile: function() {
				this.set('className', '');
			},
			addFile: function() {
				this.dialogTitle = 'Add file';
				this.intention = 'add-file';
				this.$$('paper-dialog').open();
			},
			addFolder: function() {
				this.dialogTitle = 'Add folder';
				this.intention = 'add-folder';
				this.$$('paper-dialog').open();
			},
			startRenaming: function() {
				this.intention = 'rename';
				this.renaming = true;
			},
			delete: function() {
				this.fire('delete', {path: this.path, name: this.name});
			},
			handleKeyUp: function(e) {
				// "Escape" key.
				if (e.keyCode === 27) {
					if (this.intention === 'rename') {
						this.set('renaming', false);
					}
					return;
				}
				// Not "Return" key.
				if (e.keyCode !== 13) {
					return;
				}

				this.$$('paper-dialog').close();
				this.set('renaming', false);

				var detail = this.intention === 'rename' ?
					{from: this.childPath, to: e.target.value} :
					{path: this.path + '/' + this.name + '/' + e.target.value};

				this.fire(this.intention, detail);
			},
			computeChildPath: function(path, name) {
				return path + '/' + name;
			},
			showContextMenu: function(e) {
				e.preventDefault();
				this.fire('show-menu', {
					'x': e.pageX,
					'y': e.pageY,
					'element': this
				});
			}
		});
	</script>
</dom-module>
