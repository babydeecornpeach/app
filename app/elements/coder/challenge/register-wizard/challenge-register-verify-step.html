<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../../bower_components/paper-input/all-imports.html">
<link rel="import" href="../../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../../bower_components/paper-toast/paper-toast.html">

<dom-module id="challenge-location-step">
	<style include="iron-flex">
		:host{
			display: block;
			height: 100%;
		}

		#buttons {
			@apply(--layout-horizontal);
		}

	</style>
	<template>
		<base-wizard>
			fdgdfgdgggfdgfdgd
		</base-wizard>
		<paper-toast id="toast"></paper-toast>
	</template>
	<script type="application/javascript" src="../../../../scripts/behaviors/app-connection-behavior.js"></script>
	<script>
		Polymer({
			is: 'challenge-location-step',
			behaviors: [
				Behaviors.AppConnection
			],
			properties: {
				showNameEdit: {
					value: true
				},
				nextDisabled: {
					value: false,
					notify: true
				},
				location: {
					notify: true,
					reflectToAttribute: true
				}
			},
			observers: [
				'_locationsLoaded(locations)',
				'_selectedLocationChanged(selectedLocation)',
				'_locationSet(location, locations)',
				'_participationSet(participation)'
			],
			listeners: {
				'keyup': '_updateNextDisabled',
				'back': 'prev'
			},
			prev: function(){
				this.fire('prev-step');
			},
			_participationSet: function(participation){
				if(!participation.location){
					this.readOnlyLocation =  'online';
					this.selectedLocation = {value: 'online'};
					return;
				}
				this.readOnlyLocation = 'in ' + participation.location.name;
				this.selectedLocation = {value: participation.location.id};
			},
			_locationSet: function() {
				if (!this.location || !this.locations) {
					return;
				}
				var index = -1;
				for (var i = 0; i < this.locations.length; i++) {
					if (this.locations[i].id === this.location.id) {
						index = i;
					}
				}
				if (index > -1){
					this.selectedIndex = index;
				}
			},
			_updateNextDisabled: function(){
				var formValid = !!this.$$('#form') && this.$$('#form').validate() && this.user.firstName !== null && this.user.lastName !== null;
				this.nextDisabled = this.showNameEdit ?  !formValid : false;
			},
			_locationsLoaded: function(){
				if(!this.locations){
					this.locations = [];
				}
				this.unshift('locations', {id: 'online', name: 'Online'});
				this.selectedIndex = 0;
			},
			_selectedLocationChanged(selectedLocation){
				this.showNameEdit = (!!selectedLocation && selectedLocation.value !== 'online');
				this._updateNextDisabled();
			},
			_next: function(){
				this.location = this.selectedLocation ? (this.selectedLocation.value === 'online' ? '' : this.selectedLocation.value) : '';
				if(this.selectedLocation.value === 'online'){
					this.fire('next-step');
					return;
				}
				this.$.updateUser.body = this.user;
				this.$.updateUser.url = util.build('/user');
				this.$.updateUser.generateRequest();
			},
			_onResponse: function(){
				this.fire('next-step');
			},
			_onError: function(){
				this.$.toast.text = 'There was a problem when trying update your user. Please try again later.';
				this.$.toast.show();
			},
			refresh: function(){
				this.$$('locations-by-challenge-canonical-name-provider').refresh();
			}
		});
	</script>
</dom-module>
