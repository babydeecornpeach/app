<dom-module id="candidate-page">
  <style>
    #createActionButton{
      position: absolute;
      right: 2%;
      bottom: 5%;
      --paper-fab-background: red;
    }

    .margined{
      margin: 10px;
    }
  </style>
  <template>
    <iron-ajax
      id="getChallengesAjax"
      handle-as="json"
      on-response="onGetChallengesResponse"
      on-error="onError">
    </iron-ajax>

    <iron-ajax
      id="inviteCandidate"
      handle-as="json"
      on-response="onPostResponse"
      on-error="onError">
    </iron-ajax>
    <paper-fab id="createActionButton" on-click="toggleDialog" icon="create"></paper-fab>
    <paper-dialog id="dialog" modal style="background: white;">
      <h2>Invite candidate</h2>
      <p>The address format must be: Name (first and last name or a combination) &ltemail address&gt</p>
      <form is="iron-form" id="form">
        <paper-input id="address" class="margined" label="Address" value="{{Address}}"></paper-input>
        <select id="challenges" class="margined" value="{{Challenge}}"></select><br>
        <div style="float: right;">
          <paper-button dialog-dismiss class="margined">Cancel</paper-button>
          <paper-button class="colorful margined" raised on-click="inviteCandidate" dialog-confirm>Invite</paper-button>
        </div>
      </form>
    </paper-dialog>
  </template>

  <script>
    Polymer({
      is: 'candidate-page',
      properties: {
        Address: String,
        Challenge: String
      },
      getChallenges: function(){
        get(this.$.getChallengesAjax, '/companies/' + localStorage.getItem("companyKey") + '/challenges');
      },
      inviteCandidate: function(){
        post(this.$.inviteCandidate, '/invitations', {'Address': this.Address, 'Challenge': this.getSelectedChallenge()})
      },
      onGetChallengesResponse: function(res) {
        var select = this.$.challenges;
        var challenges = res.detail.response;
        for (var i = 0; i< challenges.length; i++){
          var opt = document.createElement('option');
          opt.value = challenges[i].key;
          opt.text = challenges[i].Name;
          select.appendChild(opt);
        }
      },
      onPostResponse: function(res){
        page.redirect('/challenges/' + this.getSelectedChallenge());
      },
      onError: function(error){
          handleError(error);
      },
      submitForm: function(){
        this.$.form.submit();
      },
      getSelectedChallenge: function(){
        return this.$.challenges.options[this.$.challenges.selectedIndex].value;
      },
      toggleDialog: function(){
        this.$.dialog.toggle();
      }
    })
  </script>
</dom-module>
