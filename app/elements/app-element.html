<link rel="import" href="/elements/elements.html">

<dom-module id="app-element">
	<style>
		:host {
			display: block;
			height: 100%;
			width: 100%;
			margin: 0;
			padding: 0;
		}
	</style>
	<template>
		<paper-header-panel class="fullHeight">
			<app-nav id="appNav" user-info="{{userInfo}}"></app-nav>
			<div id="sections" class="content">
				<iron-pages attr-for-selected="data-route" selected="{{route}}" class="fullHeight" style$="{{ironPagesStyle}}">
					<!-- COMMON -->
					<login-wizard id="loginWizard" data-route="login"></login-wizard>
					<register-page data-route="register"></register-page>

					<user-detail id="userDetail" data-route="user" class="fullHeight"></user-detail>

					<error-page id="error" error="{{error}}" data-route="error"></error-page>
					<paper-material elevation="1" data-route="unauthorized">
						<h2 class="paper-font-display2">You are not authorized to see this page.</h2>
					</paper-material>
					<!-- COMPANY -->
					<challenge-create id="challengeCreate" data-route="challenge-create" class="fullHeight"></challenge-create>

					<user-challenge-detail id="userChallengeDetail" data-route="userChallenge" class="fullHeight"></user-challenge-detail>

					<challenge-template-list id="challengeList" data-route="challenges"></challenge-template-list>
					<challenge-template-detail id="challengeTemplateDetail" data-route="challenge-detail"></challenge-template-detail>

					<task-form id="taskForm" edit="false" data-route="task-create"></task-form>
					<task-form id="taskEditForm" edit="true" data-route="task-edit"></task-form>
					<task-list id="taskList" data-route="tasks"></task-list>
					<task-detail id="taskDetail" data-route="task-detail"></task-detail>

					<!-- CODER -->
					<challenge-page challenge-id="{{challenge}}" data-route="challenge" class="fullHeight"></challenge-page>
				</iron-pages>
			</div>
		</paper-header-panel>

		<!-- TODO(victorbalan): enable cache in production -->
		<!--
		<platinum-sw-register
			auto-register
			clients-claim
			skip-waiting
			on-service-worker-installed="displayInstalledToast"
		>
			<platinum-sw-cache default-cache-strategy="networkFirst" precache-file="precache.json"></platinum-sw-cache>
		</platinum-sw-register>
		-->
	</template>
	<script>
		Polymer({
			is: 'app-element',
			properties: {
				selected: {
					type: String,
					notify: true,
					value: -1
				},
				ironPagesStyle: {
					type: String,
					notify: true
				},
				error: {
					type: Object,
					notify: true
				},
				userInfo: {
					type: Object,
					notify: true,
					value: {}
				}
			},
			ready: function(){
				var element = this;
				// See https://github.com/Polymer/polymer/issues/1381
				window.addEventListener('WebComponentsReady', function() {
					// imports are loaded and elements have been registered
					if(element.route !== 'token' && element.route !== 'login' && element.route !== 'register'){
						element.initializeUserInfo();
					}
				});
			},
			initializeUserInfo: function(){
				var self = this;
				var cookieService = document.createElement('cookie-service');
				cookieService.addEventListener('user-ok', function(e){
					self.userInfo = e.detail;
					self.refreshMenu();
				});
				cookieService.addEventListener('user-error', function(e){
					page.redirect('/login');
				});
				cookieService.login();
			},
			startLoading: function(){
				this.$.appNav.startLoading();
				this.ironPagesStyle = 'display: none;';
			},
			stopLoading: function(){
				this.$.appNav.stopLoading();
				this.ironPagesStyle = '';
			},
			login: function(user, organization) {
				this.userInfo.user = user;
				this.userInfo.organization = organization;
				this.refreshMenu();
				page.redirect('/');
			},
			logout: function() {
				this.userInfo = {};
				localStorage.clear();
				this.refreshMenu();
				page.redirect('/login');
			},
			refreshMenu: function() {
				this.$.appNav.refresh();
			},
			displayInstalledToast: function() {
				console.log('Caching complete.');
			},
			inviteByToken: function(token){
				var invitationRequest = document.createElement('iron-ajax');
				invitationRequest.withCredentials = true;
				invitationRequest.url = util.build('/invite/auth/' + token);
				var self = this;
				invitationRequest.addEventListener('response', function(r){
					localStorage.user = JSON.stringify({id: 0, name: 'mocked'});
					self.initializeUserInfo();
					page('/challenge/' + r.detail.response);
				});
				invitationRequest.generateRequest();
			}
		});
	</script>
</dom-module>
