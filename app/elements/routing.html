<script src="../bower_components/page/page.js"></script>
<script>
window.addEventListener('WebComponentsReady', function() {
	page('/', function() {
		checkAuthorization();
		if (util.company()) {
			page('/candidates');
		} else {
			page('/challenge');
		}
	});

	page('/token/:token', function(context) {
		app.showProgress();
		var token = context.params.token;
		var decodedToken = atob(token).split(':');
		var accessToken = { Value: decodedToken[1] };
		localStorage.accessToken = JSON.stringify(accessToken);
		localStorage.setItem('challenge', decodedToken[0]);
		// TODO(flowlo): Request /user to set localStorage.user, but
		// this is currently not needed.
		app.login();
	});

	page('/register', function() {
		app.route = 'register';
		Polymer.Base.importHref('/elements/register/register-page.html');
	});

	page('/challenge', function() {
		checkAuthorization();
		app.route = 'challenge';
		Polymer.Base.importHref('/elements/submission/challenge-page.html', function(){
			app.startChallenge();
		});
	});

	page('/challenges', function () {
		checkAuthorization();
		app.route = 'challenges';
		Polymer.Base.importHref('/elements/challenge/challenge-list.html', function(){
			app.$.challengeList.getChallenges();
		});
	});

	page('/challenges/:challengeKey', function(data){
		checkAuthorization();
		checkIsCompany();
		app.route = 'challenge-detail';
		Polymer.Base.importHref('/elements/challenge/challenge-detail.html', function(){
			app.$.challengeDetail.loadData(data.params.challengeKey);
		});
	});

	page('/unauthorized', function() {
		app.route = 'unauthorized';
	});

	page('/coders/:id', function(data) {
		checkAuthorization();
		checkIsCompany();
		app.route = 'coder-info';
		app.params = data.params;
	});

	page('/candidates', function() {
		checkAuthorization();
		checkIsCompany();
		app.route = 'candidate';
		Polymer.Base.importHref('/elements/candidates/candidate-page.html', function(){
			app.$.candidatePage.getChallenges();
			app.$.candidatePage.getCandidates();
		});
	});

	page('/tasks', function() {
		checkAuthorization();
		checkIsCompany();
		app.route = 'tasks';
		Polymer.Base.importHref('/elements/task/task-list.html', function(){
			app.$.taskList.getTasks();
		});
	});

	page('/tasks/:taskKey', function(data) {
		checkAuthorization();
		checkIsCompany();
		app.route = 'task-detail';
		Polymer.Base.importHref('/elements/task/task-detail.html', function() {
			app.$.taskDetail.getTask(data.params.taskKey);
		});
	});

	page('/task/create', function(){
		checkAuthorization();
		checkIsCompany();
		app.route = 'task-create';
		Polymer.Base.importHref('/elements/task/task-form.html');
	});

	page('/user/:userKey', function(context){
		checkAuthorization();
		checkIsCompany();
		app.route = 'user';
		Polymer.Base.importHref('/elements/user/user-detail.html', function(){
			app.$.userDetail.getData(context.params.userKey);
		});
	});

	page('/user/:userKey/challenge/:challengeKey', function(context){
		checkAuthorization();
		checkIsCompany();
		app.route = 'userChallenge';
		Polymer.Base.importHref('/elements/user/challenge/user-challenge-detail.html', function(){
			app.$.userChallengeDetail.getData(context.params.userKey, context.params.challengeKey);
		});
	});

	page('/login', function(ctx) {
		if (hasAuthorization()) {
			if (localStorage.company) {
				page('/candidates');
			} else {
				page('/challenge');
			}
		} else {
			app.route = 'login';
			Polymer.Base.importHref('/elements/login-wizard/login-wizard.html', function(){
				if(!ctx.querystring){
					return;
				}
				var qs = ctx.querystring.split('&');
				for(var i=0;i<qs.length;i++) {
					if(qs[i].indexOf('address=')===0) {
						app.$.loginWizard.setEmail(qs[i].split('=')[1]);
						return;
					}
				}
			});
		}
	});

	page('/logout', function() {
		app.logout();
	});

	page('/error', function() {
		app.$.error.initialError = util.initialError;
		app.route = 'error';
	});

	page({
		hashbang: true
	});

	function checkAuthorization() {
		return !!localStorage.accessToken || page.redirect('/login');
	}

	function hasAuthorization() {
		return !!localStorage.accessToken;
	}

	function checkIsCompany() {
		return (!!localStorage.accessToken && !!localStorage.company) || page.redirect('/login');
	}
});
</script>
