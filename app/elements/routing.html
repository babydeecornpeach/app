<script src="../bower_components/page/page.js"></script>
<script>
window.addEventListener('WebComponentsReady', function() {

	function base(success, error){
		if(app.user && Object.keys(app.user).length !== 0){
			return success();
		}
		app.loadUser(success, error);
	}
	// COMMON
	page('/', function() {
		base(function(){
			if (app.user.activeOrganization) {
				return page('/challengetemplates');
			}
			if(localStorage.contextKey === 'challenge-register'){
				localStorage.removeItem('contextKey');
				localStorage.removeItem('contextValue');
				return page('/contest/' + localStorage.contextValue + '/register');
			}
			page('/contests');
		});
	});

	page('/settings', function() {
		base(function(){
			app.swapContent(document.createElement('settings-page'));
		});
	});

	page('/register', function() {
		base(function(){
			page('/');
		}, function(){
			app.swapContent(document.createElement('register-page'));
		});
	});

	page('/unauthorized', function() {
		// TODO
	});

	page('/login', function(ctx) {
		base(function(){
			page('/');
		}, function(){
			var content = document.createElement('login-wizard');
			app.swapContent(content);
		});
	});

	page('/logout', function() {
		app.logout();
	});

	page('/error', function() {
		var page = document.createElement('error-page');
		page.error = app.error;
		app.swapContent(page);
	});

	page('/u/:username', function(ctx) {
		base(function(){
			var page = document.createElement('profile-page');
			page.username = ctx.params.username;
			page.isCurrentUser = (ctx.params.username === app.user.username);
			app.swapContent(page);
			if(!ctx.querystring){
				return;
			}
			var qs = ctx.querystring.split('&');
			for(var i=0;i<qs.length;i++) {
				if(qs[i].indexOf('teamCreate=')===0 && qs[i].split('=')[1]==='true') {
					page.createTeam();
					return;
				}
			}
		});
	});

	page('/t/:canonicalName', function(ctx) {
		base(function(){
			var page = document.createElement('team-profile-page');
			page.canonicalName = ctx.params.canonicalName;
			app.swapContent(page);
		});
	});
	// admin
	page('/admin', function() {
		base(function(){
			app.swapContent(document.createElement('admin-page'));
		});
	});

	// COMPANY
	page('/challenge/create', function() {
		base(function(){
			var page = document.createElement('task-list');
			page.startChallengeCreation();
			app.swapContent(page);
		});
	});

	page('/challenges/:canonicalName', function(ctx) {
		base(function(){
			var page = document.createElement('challenge-detail');
			page.canonicalName = ctx.params.canonicalName;
			app.swapContent(page);
		});
	});

	page('/challengetemplates', function () {
		base(function(){
			app.swapContent(document.createElement('challenge-template-list'));
		});
	});

	page('/challenges/template/:id', function(ctx){
		base(function(){
			var page = document.createElement('challenge-template-detail');
			page.challengeTemplateId = ctx.params.id;
			app.swapContent(page);
		});
	});

	page('/challenge/template/:templateId/create', function(ctx) {
		base(function(){
			var page = document.createElement('challenge-create');
			page.challengeTemplate = ctx.params.templateId;
			app.swapContent(page);
		});
	});

	page('/tasks', function() {
		base(function(){
			app.swapContent(document.createElement('task-list'));
		});
	});

	page('/tasks/:id', function(ctx) {
		base(function(){
			var page = document.createElement('task-detail');
			page.taskId = ctx.params.id;
			app.swapContent(page);
		});
	});

	page('/task/create', function(){
		base(function(){
			app.swapContent(document.createElement('task-form'));
		});
	});

	page('/task/edit/:id', function(ctx){
		base(function(){
			var page = document.createElement('task-form');
			page.taskId = ctx.params.id;
			app.swapContent(page);
		});
	});

	// CODER
	page('/token/:token', function(ctx) {
		app.inviteByToken(ctx.params.token);
	});

	page('/contests', function() {
		base(function(){
			app.swapContent(document.createElement('available-challenges-page'));
		});
	});

	page('/contest/:canonicalName/register', function(ctx) {
		base(function(){
			page('/contest/' + ctx.params.canonicalName + '/info');
		}, function(){
			var wizard = document.createElement('challenge-register-wizard');
			wizard.canonicalName = ctx.params.canonicalName;
			app.swapContent(wizard);
		});
	});

	page('/contest/:canonicalName', function(ctx) {
		base(function(){
			var page = document.createElement('challenge-page');
			page.canonicalName = ctx.params.canonicalName;
			app.swapContent(page);
		});
	});

	page('/contest/:canonicalName/info', function(ctx) {
		base(function(){
			var page = document.createElement('challenge-info-page');
			page.canonicalName = ctx.params.canonicalName;
			app.swapContent(page);
		});
	});

	page('/contest/:id/result', function(ctx) {
		base(function(){
			var page = document.createElement('contest-result');
			page.challengeId = ctx.params.id;
			app.swapContent(page);
		});
	});

	page({
		hashbang: false
	});
});
</script>
