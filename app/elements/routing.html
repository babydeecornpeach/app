<script src="../bower_components/page/page.js"></script>
<script src="../bower_components/js-base64/base64.js"></script>
<script>
  window.addEventListener('WebComponentsReady', function() {
    page('/token/:token', function(context){
      var token = context.params.token;
      if (Base64.extendString) {
        Base64.extendString();
        var decodedToken = token.fromBase64().split(":");
        localStorage.setItem("token", decodedToken[1]);
        localStorage.setItem("role", "CODER");
        app.requestData(decodedToken[0]);
      }
      window.location = "/codeground/#!/codingGround";
    });

    page('/codingGround', function () {
      checkLoggedIn();
      app.route = 'codingGround';
      app.header = "Coding ground"
    });

    page('/unauthorized', function(){
      app.route = 'unauthorized';
    });

    // DASHBOARD
    page('/dashboard', function () {
      checkLoggedIn();
      checkIsCompany();
      app.route = 'dashboard';
    });

    page('/coders', function () {
      checkLoggedIn();
      checkIsCompany();
      app.route = 'coders';
    });

    page('/coders/:id', function (data) {
      checkLoggedIn();
      checkIsCompany();
      app.route = 'coder-info';
      app.params = data.params;
    });

    page('/fingerprints', function () {
      checkLoggedIn();
      checkIsCompany();
      app.route = 'fingerprints';
    });

    page('/candidate', function () {
      checkLoggedIn();
      checkIsCompany();
      app.route = 'candidate';
    });

    page('/login', function(){
      app.route = 'login';
    });

    // add #! before urls
    page({
      hashbang: true
    });

    function checkLoggedIn(){
      var loggedIn = localStorage.getItem("token");
      if(loggedIn=="" || loggedIn==undefined){
        page.redirect("/login");
      }
    }

    function checkIsCompany(){
      var role = localStorage.getItem("role");
      if(role==undefined || role=="" || role!="COMPANY"){
        console.log(role + " is not COMPANY");
        page.redirect("/login");
      }
    }
  });
</script>
