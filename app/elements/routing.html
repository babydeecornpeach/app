<script src="../bower_components/page/page.js"></script>
<script>
  window.addEventListener('WebComponentsReady', function() {
    page('/', '/login');

    page('/token/:token', function(context) {
      var token = context.params.token;
      var decodedToken = atob(token).split(':');
      localStorage.setItem("authorization", 'Token ' + decodedToken[1]);
      localStorage.setItem("role", "CODER");
      app.requestData(decodedToken[0]);
      page('/codeground')
    });

    page('/codeground', function() {
      checkLoggedIn();
      app.route = 'code';
    });

    page('/unauthorized', function() {
      app.route = 'unauthorized';
    });

    // DASHBOARD
    page('/dashboard', function () {
      checkLoggedIn();
      checkIsCompany();
      app.route = 'dashboard';
    });

    page('/coders', function() {
      checkLoggedIn();
      checkIsCompany();
      app.route = 'coders';
    });

    page('/coders/:id', function(data) {
      checkLoggedIn();
      checkIsCompany();
      app.route = 'coder-info';
      app.params = data.params;
    });

    page('/fingerprints', function() {
      checkLoggedIn();
      checkIsCompany();
      app.route = 'fingerprints';
    });

    page('/candidate', function() {
      checkLoggedIn();
      checkIsCompany();
      app.route = 'candidate';
    });

    page('/login', function() {
      app.route = 'login';
    });

    page({
      // Add '#!' before page paths
      hashbang: true
    });

    // TODO(flowlo): checkLoggedIn is a bad name for this.
    // Only because we have a token, this does not mean that
    // we are logged in.
    function checkLoggedIn() {
      var loggedIn = localStorage.getItem("token");
      if (loggedIn === "" || loggedIn === undefined) {
        page.redirect("/login");
      }
    }

    function checkIsCompany() {
      var role = localStorage.getItem("role");
      if (role === undefined || role === "" || role !== "COMPANY") {
        page.redirect("/login");
      }
    }
  });
</script>
