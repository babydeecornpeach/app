<script src="../bower_components/page/page.js"></script>
<script>
  window.addEventListener('WebComponentsReady', function() {
    page('/', function(){
      checkAuthorization();
      if(localStorage.getItem("role")==="COMPANY"){
        page('/dashboard');
      }else{
        page('/challenges')
      }
    });

    page('/token/:token', function(context) {
      var token = context.params.token;
      var decodedToken = atob(token).split(':');
      localStorage.setItem("authorization", 'Token ' + decodedToken[1]);
      localStorage.setItem("role", "CODER");
      app.requestData(decodedToken[0]);
      page('/challenge')
    });

    page('/challenge', function() {
      checkAuthorization();
      app.route = 'challenge';
      app.header = "Challenge"
    });

    page('/challenges', function () {
      checkAuthorization();
      app.$.challengeList.getChallenges();
      app.route = 'challenges';
    });

    page('/challenges/:challengeKey', function(data){
      checkAuthorization();
      app.$.challengeDetail.challengeKey = data.params.challengeKey;
      app.route = 'challenge-detail';
    });

    page('/unauthorized', function() {
      app.route = 'unauthorized';
      app.header = "Unauthorized"
    });

    // DASHBOARD
    page('/dashboard', function () {
      checkAuthorization();
      checkIsCompany();
      app.route = 'dashboard';
      app.header = "Dashboard"
    });

    page('/coders', function() {
      checkAuthorization();
      checkIsCompany();
      app.route = 'coders';
      app.header = "Coders"
    });

    page('/coders/:id', function(data) {
      checkAuthorization();
      checkIsCompany();
      app.route = 'coder-info';
      app.params = data.params;
    });

    page('/fingerprints', function() {
      checkAuthorization();
      checkIsCompany();
      app.route = 'fingerprints';
    });

    page('/candidate', function() {
      checkAuthorization();
      checkIsCompany();
      app.route = 'candidate';
      app.$.inviteCandidate.getChallenges();
      app.header = 'Candidate';
    });

    page('/login', function() {
      app.route = 'login';
      app.header = "Login"
    });

    //################################## ERROR PAGES

    page('/500', function(){
      var lastError = getLastError();
      console.log(lastError);
      app.$.error500.initialError = lastError;
      app.header = 'Oops...';
      app.route = '500';
    });

    page({
      // Add '#!' before page paths
      hashbang: true
    });

    function checkAuthorization(){
      if(!hasAuthorization()){
        page.redirect("/login");
      }
    }
    function hasAuthorization() {
      return !!localStorage.getItem("authorization");
    }

    function checkIsCompany() {
      var role = localStorage.getItem("role");
      if (role === undefined || role === "" || role !== "COMPANY") {
        page.redirect("/login");
      }
    }
  });
</script>
